<div class="h-full flex flex-col relative">

   <!-- Top Section: Navigation & Header -->
   <div class="shrink-0 flex flex-col gap-4 md:gap-6 mb-4 md:mb-6">
      <!-- Navigation Breadcrumb -->
      <nav class="flex items-center">
         <a routerLink="/usuarios"
            class="group inline-flex items-center gap-2 text-slate-500 hover:text-purple-600 transition-all duration-200 text-sm font-medium">
            <div
               class="w-8 h-8 rounded-lg bg-white shadow-sm border border-slate-200 flex items-center justify-center group-hover:shadow-md group-hover:border-purple-200 transition-all">
               <svg class="w-4 h-4 group-hover:-translate-x-0.5 transition-transform" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2">
                  <path d="M19 12H5M12 19l-7-7 7-7" />
               </svg>
            </div>
            <span class="group-hover:underline underline-offset-2">Volver a Usuarios</span>
         </a>
      </nav>

      <!-- Header Card -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-5">
         <div class="flex flex-col sm:flex-row sm:items-center gap-4">
            <!-- Icon & Title -->
            <div class="flex items-center gap-4 flex-1 min-w-0">
               <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center flex-shrink-0">
                  <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                     stroke-width="2">
                     <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                     <path d="M7 11V7a5 5 0 0110 0v4" />
                  </svg>
               </div>
               <div class="min-w-0">
                  <h1 class="text-xl font-bold text-slate-800">Permisos de Usuario</h1>
                  <p class="text-sm text-slate-500">Configura los accesos y permisos especiales</p>
               </div>
            </div>

            <!-- User Info -->
            <div *ngIf="usuario()"
               class="flex items-center gap-3 bg-slate-50 px-4 py-3 rounded-xl border border-slate-100">
               <div
                  class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                  {{ getInitials(usuario()!) }}
               </div>
               <div class="min-w-0">
                  <p class="font-semibold text-slate-700 text-sm truncate">{{ usuario()!.nombre }}</p>
                  <p class="text-xs text-slate-400 truncate">{{ usuario()!.correo }}</p>
               </div>
               <span
                  class="ml-2 px-3 py-1.5 bg-purple-100 text-purple-700 text-xs font-semibold rounded-full whitespace-nowrap">
                  {{ getRolName(usuario()!) }}
               </span>
            </div>
         </div>
      </div>

      <!-- Toolbar (Search & Stats) -->
      <div *ngIf="!loading()" @fadeIn
         class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-sm border border-slate-200 p-3 md:p-4">
         <div class="flex flex-col sm:flex-row gap-4 items-stretch sm:items-center justify-between">
            <!-- Stats Badge -->
            <div class="flex items-center gap-2 sm:gap-4 flex-wrap">
               <div
                  class="flex items-center gap-3 px-3 py-2 md:px-4 md:py-2.5 bg-gradient-to-r from-emerald-50 to-emerald-100 rounded-xl border border-emerald-200">
                  <div class="w-3 h-3 rounded-full bg-emerald-500 animate-pulse"></div>
                  <span class="text-sm font-semibold text-emerald-700">
                     {{ totalAsignados() }} de {{ totalPermisos() }} activos
                  </span>
               </div>

               <!-- Quick Actions -->
               <div class="hidden sm:flex items-center gap-1 bg-slate-100 rounded-xl p-1">
                  <button (click)="toggleTodos(true)"
                     class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-emerald-700 hover:bg-emerald-100 rounded-lg transition-colors">
                     <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                     </svg>
                     Activar todos
                  </button>
                  <button (click)="toggleTodos(false)"
                     class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition-colors">
                     <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                     </svg>
                     Desactivar
                  </button>
               </div>
            </div>

            <!-- Search Input -->
            <div class="relative w-full sm:w-72">
               <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8" />
                  <path d="M21 21l-4.35-4.35" />
               </svg>
               <input type="text" [(ngModel)]="searchQuery" placeholder="Buscar permisos..."
                  class="w-full pl-12 pr-4 py-3 bg-slate-50 border-2 border-transparent rounded-xl text-sm font-medium focus:outline-none focus:bg-white focus:border-purple-400 focus:shadow-lg focus:shadow-purple-500/10 transition-all placeholder:text-slate-400">
            </div>
         </div>
      </div>
   </div>

   <!-- Loading State -->
   <div *ngIf="loading()" class="flex-1 flex flex-col items-center justify-center gap-5">
      <div class="relative">
         <div class="w-16 h-16 border-4 border-purple-200 rounded-full"></div>
         <div
            class="absolute inset-0 w-16 h-16 border-4 border-purple-600 border-t-transparent rounded-full animate-spin">
         </div>
      </div>
      <p class="text-slate-500 font-medium">Cargando permisos...</p>
   </div>

   <!-- Categories Scrollable Grid -->
   <div *ngIf="!loading()" @fadeIn class="flex-1 min-h-0 overflow-y-auto simple-scrollbar pb-6">

      <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 md:gap-6 pb-24">
         <div *ngFor="let cat of filteredCategorias()"
            class="group bg-white rounded-2xl shadow-sm border overflow-hidden transition-all duration-300 hover:shadow-lg"
            [class.border-slate-200]="true" [class.hover:border-amber-300]="getCategoryTheme(cat.categoria) === 'amber'"
            [class.hover:border-purple-300]="getCategoryTheme(cat.categoria) === 'purple'"
            [class.hover:border-emerald-300]="getCategoryTheme(cat.categoria) === 'emerald'"
            [class.hover:border-blue-300]="getCategoryTheme(cat.categoria) === 'blue'">

            <!-- Category Header -->
            <button (click)="toggleCategoria(cat)"
               class="w-full px-4 py-4 md:px-6 md:py-5 flex items-center gap-4 transition-colors"
               [ngClass]="getCategoryHoverClass(cat.categoria)">
               <div
                  class="w-12 h-12 md:w-14 md:h-14 rounded-2xl flex items-center justify-center shadow-md transition-transform group-hover:scale-105"
                  [ngClass]="getCategoryBgClass(cat.categoria)">
                  <div class="w-5 h-5 md:w-6 md:h-6" [innerHTML]="getCategoryIcon(cat.categoria)"></div>
               </div>
               <div class="flex-1 text-left">
                  <h3 class="text-base md:text-lg font-bold text-slate-800">{{ cat.categoria }}</h3>
                  <p class="text-xs md:text-sm text-slate-500">{{ cat.permisos.length }} permisos disponibles</p>
               </div>

               <!-- Progress & Toggle -->
               <div class="flex items-center gap-3 md:gap-4">
                  <div class="hidden sm:flex flex-col items-end gap-1">
                     <span class="text-sm font-bold"
                        [class.text-amber-600]="getCategoryTheme(cat.categoria) === 'amber'"
                        [class.text-purple-600]="getCategoryTheme(cat.categoria) === 'purple'"
                        [class.text-emerald-600]="getCategoryTheme(cat.categoria) === 'emerald'"
                        [class.text-blue-600]="getCategoryTheme(cat.categoria) === 'blue'">
                        {{ getAssignedCount(cat) }}/{{ cat.permisos.length }}
                     </span>
                     <div class="w-16 md:w-24 h-1.5 md:h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-500"
                           [class.bg-amber-500]="getCategoryTheme(cat.categoria) === 'amber'"
                           [class.bg-purple-500]="getCategoryTheme(cat.categoria) === 'purple'"
                           [class.bg-emerald-500]="getCategoryTheme(cat.categoria) === 'emerald'"
                           [class.bg-blue-500]="getCategoryTheme(cat.categoria) === 'blue'"
                           [style.width.%]="(getAssignedCount(cat) / cat.permisos.length) * 100"></div>
                     </div>
                  </div>
                  <div class="w-8 h-8 md:w-10 md:h-10 rounded-xl flex items-center justify-center transition-all"
                     [class.bg-amber-100]="getCategoryTheme(cat.categoria) === 'amber' && cat.expandido"
                     [class.bg-purple-100]="getCategoryTheme(cat.categoria) === 'purple' && cat.expandido"
                     [class.bg-emerald-100]="getCategoryTheme(cat.categoria) === 'emerald' && cat.expandido"
                     [class.bg-blue-100]="getCategoryTheme(cat.categoria) === 'blue' && cat.expandido"
                     [class.bg-slate-100]="!cat.expandido">
                     <svg class="w-4 h-4 md:w-5 md:h-5 transition-transform duration-300"
                        [class.rotate-180]="cat.expandido"
                        [class.text-amber-600]="getCategoryTheme(cat.categoria) === 'amber'"
                        [class.text-purple-600]="getCategoryTheme(cat.categoria) === 'purple'"
                        [class.text-emerald-600]="getCategoryTheme(cat.categoria) === 'emerald'"
                        [class.text-blue-600]="getCategoryTheme(cat.categoria) === 'blue'" fill="none"
                        stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                        <path d="M19 9l-7 7-7-7" />
                     </svg>
                  </div>
               </div>
            </button>

            <!-- Permissions List -->
            <div [@expandCollapse]="cat.expandido ? 'expanded' : 'collapsed'">
               <!-- Quick Actions Bar -->
               <div class="px-4 py-3 md:px-6 flex items-center justify-between border-t border-b"
                  [class.bg-amber-50]="getCategoryTheme(cat.categoria) === 'amber'"
                  [class.border-amber-100]="getCategoryTheme(cat.categoria) === 'amber'"
                  [class.bg-purple-50]="getCategoryTheme(cat.categoria) === 'purple'"
                  [class.border-purple-100]="getCategoryTheme(cat.categoria) === 'purple'"
                  [class.bg-emerald-50]="getCategoryTheme(cat.categoria) === 'emerald'"
                  [class.border-emerald-100]="getCategoryTheme(cat.categoria) === 'emerald'"
                  [class.bg-blue-50]="getCategoryTheme(cat.categoria) === 'blue'"
                  [class.border-blue-100]="getCategoryTheme(cat.categoria) === 'blue'">
                  <span class="text-[10px] md:text-xs font-bold uppercase tracking-wider"
                     [class.text-amber-700]="getCategoryTheme(cat.categoria) === 'amber'"
                     [class.text-purple-700]="getCategoryTheme(cat.categoria) === 'purple'"
                     [class.text-emerald-700]="getCategoryTheme(cat.categoria) === 'emerald'"
                     [class.text-blue-700]="getCategoryTheme(cat.categoria) === 'blue'">
                     Permisos
                  </span>
                  <div class="flex items-center gap-2">
                     <button (click)="toggleCategoriaTodos(cat, true); $event.stopPropagation()"
                        class="px-2 py-1 md:px-3 md:py-1.5 text-[10px] md:text-xs font-bold rounded-lg transition-colors"
                        [class.text-amber-700]="getCategoryTheme(cat.categoria) === 'amber'"
                        [class.hover:bg-amber-100]="getCategoryTheme(cat.categoria) === 'amber'"
                        [class.text-purple-700]="getCategoryTheme(cat.categoria) === 'purple'"
                        [class.hover:bg-purple-100]="getCategoryTheme(cat.categoria) === 'purple'"
                        [class.text-emerald-700]="getCategoryTheme(cat.categoria) === 'emerald'"
                        [class.hover:bg-emerald-100]="getCategoryTheme(cat.categoria) === 'emerald'"
                        [class.text-blue-700]="getCategoryTheme(cat.categoria) === 'blue'"
                        [class.hover:bg-blue-100]="getCategoryTheme(cat.categoria) === 'blue'">
                        <div class="flex items-center gap-1.5">
                           <svg class="w-3 h-3 md:w-3.5 md:h-3.5" fill="none" stroke="currentColor" stroke-width="2.5"
                              viewBox="0 0 24 24">
                              <path d="M5 13l4 4L19 7" />
                           </svg>
                           <span>Todos</span>
                        </div>
                     </button>
                     <button (click)="toggleCategoriaTodos(cat, false); $event.stopPropagation()"
                        class="px-2 py-1 md:px-3 md:py-1.5 text-[10px] md:text-xs font-bold text-slate-500 hover:bg-slate-100 rounded-lg transition-colors">
                        <div class="flex items-center gap-1.5">
                           <svg class="w-3 h-3 md:w-3.5 md:h-3.5" fill="none" stroke="currentColor" stroke-width="2.5"
                              viewBox="0 0 24 24">
                              <path d="M6 18L18 6M6 6l12 12" />
                           </svg>
                           <span>Nada</span>
                        </div>
                     </button>
                  </div>
               </div>

               <div class="divide-y divide-slate-100">
                  <div *ngFor="let permiso of cat.permisos">
                     <div
                        class="px-4 py-3 md:px-6 md:py-4 flex items-center gap-3 md:gap-4 cursor-pointer transition-colors"
                        (click)="togglePermiso(permiso)" [ngClass]="getCategoryHoverClass(cat.categoria)">

                        <!-- Permission Info -->
                        <div class="flex-1 min-w-0">
                           <div class="flex items-center gap-3">
                              <div class="w-8 h-8 rounded-lg flex items-center justify-center transition-all shrink-0"
                                 [class.bg-slate-100]="!permiso.asignado" [class.text-slate-400]="!permiso.asignado"
                                 [class.bg-purple-100]="permiso.asignado && getCategoryTheme(cat.categoria) === 'purple'"
                                 [class.text-purple-600]="permiso.asignado && getCategoryTheme(cat.categoria) === 'purple'"
                                 [class.bg-amber-100]="permiso.asignado && getCategoryTheme(cat.categoria) === 'amber'"
                                 [class.text-amber-600]="permiso.asignado && getCategoryTheme(cat.categoria) === 'amber'"
                                 [class.bg-emerald-100]="permiso.asignado && getCategoryTheme(cat.categoria) === 'emerald'"
                                 [class.text-emerald-600]="permiso.asignado && getCategoryTheme(cat.categoria) === 'emerald'"
                                 [class.bg-blue-100]="permiso.asignado && getCategoryTheme(cat.categoria) === 'blue'"
                                 [class.text-blue-600]="permiso.asignado && getCategoryTheme(cat.categoria) === 'blue'">
                                 <div class="w-4 h-4" [innerHTML]="getPermisoIconSvg(permiso.codigo)"></div>
                              </div>
                              <div>
                                 <h4 class="text-sm md:text-base font-semibold transition-colors leading-tight"
                                    [class.text-slate-800]="permiso.asignado"
                                    [class.text-slate-500]="!permiso.asignado">
                                    {{ permiso.nombre }}
                                 </h4>
                                 <p *ngIf="permiso.descripcion"
                                    class="text-[10px] md:text-xs text-slate-400 mt-0.5 line-clamp-1">
                                    {{ permiso.descripcion }}
                                 </p>
                              </div>
                           </div>
                        </div>

                        <!-- Themed Toggle Switch -->
                        <div
                           class="relative w-10 h-6 md:w-12 md:h-7 rounded-full transition-all duration-300 cursor-pointer flex-shrink-0"
                           [class.bg-amber-500]="permiso.asignado && getCategoryTheme(cat.categoria) === 'amber'"
                           [class.shadow-amber-500/40]="permiso.asignado && getCategoryTheme(cat.categoria) === 'amber'"
                           [class.bg-purple-500]="permiso.asignado && getCategoryTheme(cat.categoria) === 'purple'"
                           [class.shadow-purple-500/40]="permiso.asignado && getCategoryTheme(cat.categoria) === 'purple'"
                           [class.bg-emerald-500]="permiso.asignado && getCategoryTheme(cat.categoria) === 'emerald'"
                           [class.shadow-emerald-500/40]="permiso.asignado && getCategoryTheme(cat.categoria) === 'emerald'"
                           [class.bg-blue-500]="permiso.asignado && getCategoryTheme(cat.categoria) === 'blue'"
                           [class.shadow-blue-500/40]="permiso.asignado && getCategoryTheme(cat.categoria) === 'blue'"
                           [class.bg-slate-300]="!permiso.asignado" [class.shadow-lg]="permiso.asignado">
                           <div
                              class="absolute top-1 left-1 w-4 h-4 md:w-5 md:h-5 bg-white rounded-full shadow-md transition-transform duration-300 flex items-center justify-center mr-1"
                              [class.translate-x-4]="permiso.asignado" [class.md:translate-x-5]="permiso.asignado">
                              <svg *ngIf="permiso.asignado" class="w-2.5 h-2.5 md:w-3 md:h-3"
                                 [class.text-amber-500]="getCategoryTheme(cat.categoria) === 'amber'"
                                 [class.text-purple-500]="getCategoryTheme(cat.categoria) === 'purple'"
                                 [class.text-emerald-500]="getCategoryTheme(cat.categoria) === 'emerald'"
                                 [class.text-blue-500]="getCategoryTheme(cat.categoria) === 'blue'" fill="none"
                                 stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                 <path d="M5 13l4 4L19 7" />
                              </svg>
                           </div>
                        </div>
                     </div>

                     <!-- Config Panel for Informes.Editar -->
                     <div *ngIf="permiso.codigo === 'informes.editar' && permiso.asignado"
                        class="px-4 pb-3 pl-14 md:px-6 md:pb-4 md:pl-16">
                        <div class="bg-purple-50 rounded-xl border border-purple-200 p-3 md:p-4">
                           <label
                              class="block text-[10px] md:text-xs font-bold text-purple-700 uppercase tracking-wider mb-2 md:mb-3">
                              Alcance de edición
                           </label>
                           <div class="flex flex-col sm:flex-row flex-wrap sm:items-center gap-2 sm:gap-4">
                              <label class="flex items-center gap-2 cursor-pointer group">
                                 <input type="radio" name="scope_edit" [value]="'todos'" [(ngModel)]="permiso.alcance"
                                    (ngModelChange)="updateScope(permiso)" (click)="$event.stopPropagation()"
                                    class="w-4 h-4 text-purple-600 focus:ring-purple-500 border-purple-300">
                                 <span
                                    class="text-xs md:text-sm font-medium text-slate-700 group-hover:text-purple-700">Todos
                                    los grupos</span>
                              </label>
                              <label class="flex items-center gap-2 cursor-pointer group">
                                 <input type="radio" name="scope_edit" [value]="'asignados'"
                                    [(ngModel)]="permiso.alcance" (ngModelChange)="updateScope(permiso)"
                                    (click)="$event.stopPropagation()"
                                    class="w-4 h-4 text-purple-600 focus:ring-purple-500 border-purple-300">
                                 <span
                                    class="text-xs md:text-sm font-medium text-slate-700 group-hover:text-purple-700">Solo
                                    asignados</span>
                              </label>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!loading() && filteredCategorias().length === 0"
         class="flex flex-col items-center justify-center py-20 text-center">
         <div class="w-16 h-16 md:w-20 md:h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
            <svg class="w-8 h-8 md:w-10 md:h-10 text-slate-400" fill="none" stroke="currentColor" stroke-width="1.5"
               viewBox="0 0 24 24">
               <path d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
         </div>
         <p class="text-slate-500 font-medium">No se encontraron permisos</p>
      </div>
   </div>

   <!-- Floating Save Button -->
   <div *ngIf="!loading() && hasChanges()" @slideUp
      class="absolute bottom-6 left-1/2 -translate-x-1/2 w-full max-w-md px-4 pointer-events-none z-30">
      <div class="pointer-events-auto">
         <button (click)="guardar()" [disabled]="saving()"
            class="w-full py-3.5 md:py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-2xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all flex items-center justify-center gap-3 disabled:opacity-60 disabled:cursor-not-allowed">
            <svg *ngIf="!saving()" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2">
               <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z" />
               <polyline points="17 21 17 13 7 13 7 21" />
               <polyline points="7 3 7 8 15 8" />
            </svg>
            <div *ngIf="saving()" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin">
            </div>
            {{ saving() ? 'Guardando cambios...' : 'Guardar ' + changesCount() + ' cambios' }}
         </button>
      </div>
   </div>

   <!-- Success Toast -->
   <div *ngIf="showSuccess()" @slideUp
      class="absolute top-6 right-6 left-6 md:left-auto z-50 px-5 py-4 bg-emerald-500 text-white font-semibold rounded-2xl shadow-xl flex items-center gap-3">
      <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center shrink-0">
         <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M22 11.08V12a10 10 0 11-5.93-9.14" />
            <polyline points="22 4 12 14.01 9 11.01" />
         </svg>
      </div>
      <div>
         <p class="font-bold">¡Permisos actualizados!</p>
         <p class="text-sm text-emerald-100">Los cambios se guardaron correctamente</p>
      </div>
   </div>
</div>