<div
   class="h-full flex flex-col w-full bg-gradient-to-br from-slate-50 via-white to-slate-100 overflow-hidden font-sans">

   <!-- Header Moderno Responsivo -->
   <header class="shrink-0 bg-white/95 backdrop-blur-xl border-b border-slate-200/80 shadow-sm z-30 sticky top-0">
      <div class="px-4 sm:px-6 lg:px-8 py-3 sm:py-4">
         <div class="flex items-center justify-between gap-4">
            <!-- Left Section -->
            <div class="flex items-center gap-3 sm:gap-4 min-w-0">
               <button (click)="goBack()"
                  class="w-9 h-9 sm:w-10 sm:h-10 rounded-xl flex items-center justify-center text-slate-400 hover:text-slate-700 hover:bg-slate-100 transition-all active:scale-95 shrink-0">
                  <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                  </svg>
               </button>

               <div class="min-w-0">
                  <div class="flex items-center gap-2 flex-wrap">
                     <h1 class="text-lg sm:text-xl lg:text-2xl font-extrabold text-slate-900 tracking-tight truncate">
                        Asignación Dinámica</h1>
                  </div>
                  <p class="text-slate-500 text-[11px] sm:text-xs font-medium mt-0.5 hidden sm:block">Arrastra y suelta
                     para reorganizar los grupos</p>
               </div>
            </div>

            <!-- Right Section -->
            <div class="flex items-center gap-2 sm:gap-3 shrink-0">
               <!-- Full Screen Toggle Button -->
               <button (click)="toggleFullScreen()"
                  class="hidden sm:flex items-center justify-center w-9 h-9 sm:w-10 sm:h-10 rounded-xl text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition-all active:scale-95"
                  title="Pantalla Completa">
                  <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                     <path stroke-linecap="round" stroke-linejoin="round"
                        d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                  </svg>
               </button>

               <!-- Separator -->
               <div class="hidden sm:block w-px h-6 bg-slate-200 mx-1"></div>

               <!-- Cambios Pendientes Indicator -->
               <div
                  class="hidden lg:flex items-center gap-3 bg-slate-50/80 px-3 py-2 rounded-xl border border-slate-200/60"
                  *ngIf="pendingChangesCount() > 0">
                  <div class="w-8 h-8 rounded-lg bg-brand-orange flex items-center justify-center text-white">
                     <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                           d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                     </svg>
                  </div>
                  <div class="flex flex-col">
                     <span class="text-sm font-bold text-slate-800 leading-tight">{{ pendingChangesCount() }}
                        cambios</span>
                     <span class="text-[10px] text-slate-500 font-medium">sin guardar</span>
                  </div>
               </div>

               <!-- Mobile Changes Badge -->
               <div
                  class="lg:hidden flex items-center justify-center w-9 h-9 rounded-xl bg-brand-orange-soft text-brand-orange font-bold text-sm"
                  *ngIf="pendingChangesCount() > 0">
                  {{ pendingChangesCount() }}
               </div>

               <!-- Save Button -->
               <button (click)="saveChanges()" [disabled]="isSaving() || pendingChangesCount() === 0"
                  class="relative overflow-hidden px-3 sm:px-5 py-2 sm:py-2.5 bg-brand-orange text-white rounded-xl font-bold text-xs sm:text-sm shadow-lg shadow-orange-500/30 transition-all hover:bg-orange-600 hover:shadow-orange-500/40 active:scale-95 disabled:opacity-40 disabled:shadow-none disabled:cursor-not-allowed flex items-center gap-2">
                  <svg *ngIf="isSaving()" class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg"
                     fill="none" viewBox="0 0 24 24">
                     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                     <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                     </path>
                  </svg>
                  <svg *ngIf="!isSaving()" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                     stroke-width="2.5">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                  </svg>
                  <span class="hidden sm:inline">{{ isSaving() ? 'Guardando...' : 'Guardar' }}</span>
               </button>
            </div>
         </div>
      </div>
   </header>

   <!-- Kanban Board Area - Responsivo con Diseño Estético -->
   <div class="flex-1 min-h-0 p-4 sm:p-6 lg:p-8 bg-slate-50/50 transition-all duration-300" [class.p-0]="isFullScreen()"
      [class.sm:p-0]="isFullScreen()" [class.lg:p-0]="isFullScreen()">

      <div
         class="w-full h-full bg-white rounded-3xl border border-slate-200/60 shadow-[0_8px_30px_rgb(0,0,0,0.04)] overflow-hidden flex flex-col relative transition-all duration-300"
         [ngClass]="{'fixed inset-0 z-[9999] rounded-none border-0': isFullScreen()}">

         <!-- Controls Overlay for FullScreen Mode -->
         <div *ngIf="isFullScreen()"
            class="absolute top-2 right-4 sm:right-1/2 sm:translate-x-1/2 z-50 animate-fade-in-down">
            <button (click)="toggleFullScreen()"
               class="flex items-center gap-2 px-4 py-2 bg-slate-900/90 hover:bg-slate-800 text-white backdrop-blur-md rounded-full shadow-xl border border-white/10 transition-all active:scale-95 group">
               <span class="text-xs font-bold tracking-wide">Salir de Pantalla Completa</span>
               <svg class="w-3.5 h-3.5 text-slate-400 group-hover:text-white transition-colors" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
               </svg>
            </button>
         </div>

         <!-- Sombras decorativas laterales (Fade effect manual) -->
         <div class="absolute inset-y-0 left-0 w-8 bg-gradient-to-r from-white to-transparent z-10 pointer-events-none">
         </div>
         <div
            class="absolute inset-y-0 right-0 w-8 bg-gradient-to-l from-white to-transparent z-10 pointer-events-none">
         </div>

         <div class="flex-1 overflow-x-auto overflow-y-hidden p-6 custom-scrollbar" [class.px-8]="isFullScreen()"
            [class.pb-8]="isFullScreen()" [class.pt-14]="isFullScreen()">
            <div class="flex h-full gap-5 pb-2">

               <!-- Columna: Sin Asignar (Staging Area) -->
               <div
                  class="w-64 sm:w-72 shrink-0 flex flex-col rounded-2xl bg-gradient-to-b from-slate-100 to-slate-50 border border-slate-300 shadow-[0_4px_12px_rgba(0,0,0,0.08)] max-h-full transition-all duration-300 snap-start"
                  [class.bg-brand-orange-soft]="isDraggingOver() === 'unassigned'"
                  [class.border-brand-orange]="isDraggingOver() === 'unassigned'"
                  [class.shadow-xl]="isDraggingOver() === 'unassigned'" (dragover)="onDragOver($event, 'unassigned')"
                  (dragleave)="onDragLeave()" (drop)="onDrop($event, null)">
                  <!-- Header -->
                  <div
                     class="px-4 py-3 border-b border-slate-200/60 flex items-center justify-between rounded-t-2xl bg-white/60 backdrop-blur-sm">
                     <div class="flex items-center gap-2.5">
                        <div class="w-8 h-8 rounded-lg bg-slate-200 flex items-center justify-center">
                           <svg class="w-4 h-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                              stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round"
                                 d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                           </svg>
                        </div>
                        <div>
                           <p class="font-bold text-slate-700 text-sm">Sin Asignar</p>
                           <p class="text-[10px] text-slate-400">Zona de espera</p>
                        </div>
                     </div>
                     <span class="bg-slate-800 text-white px-2.5 py-1 rounded-lg text-xs font-bold tabular-nums">{{
                        unassignedPublishers().length }}</span>
                  </div>

                  <!-- List -->
                  <div class="p-3 flex-1 overflow-y-auto space-y-2 custom-scrollbar">
                     <ng-container *ngFor="let p of unassignedPublishers()">
                        <ng-container *ngTemplateOutlet="cardTemplate; context: { $implicit: p }"></ng-container>
                     </ng-container>

                     <div *ngIf="unassignedPublishers().length === 0"
                        class="py-12 flex flex-col items-center justify-center text-slate-400 text-xs">
                        <div class="w-12 h-12 rounded-xl bg-slate-100/80 flex items-center justify-center mb-3">
                           <svg class="w-6 h-6 text-slate-300" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                              stroke-width="1.5">
                              <path stroke-linecap="round" stroke-linejoin="round"
                                 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                           </svg>
                        </div>
                        <span class="font-medium">Sin publicadores pendientes</span>
                        <span class="text-[10px] text-slate-300 mt-1">Todos están asignados</span>
                     </div>
                  </div>
               </div>

               <!-- Columnas: Grupos - Diseño Profesional -->
               <div *ngFor="let grupo of grupos()"
                  class="w-64 sm:w-72 shrink-0 flex flex-col rounded-2xl bg-white border border-slate-300 shadow-[0_4px_16px_rgba(0,0,0,0.1)] hover:shadow-[0_8px_24px_rgba(0,0,0,0.15)] ring-1 ring-black/5 max-h-full transition-all duration-300 snap-start"
                  [class.ring-2]="isDraggingOver() === grupo.id_grupo"
                  [class.ring-brand-orange]="isDraggingOver() === grupo.id_grupo"
                  [class.shadow-xl]="isDraggingOver() === grupo.id_grupo"
                  (dragover)="onDragOver($event, grupo.id_grupo)" (dragleave)="onDragLeave()"
                  (drop)="onDrop($event, grupo.id_grupo)">
                  <!-- Header con color de marca (Naranja) -->
                  <div class="px-4 py-3 bg-gradient-to-r from-orange-500 to-orange-600 rounded-t-2xl">
                     <div class="flex flex-col">
                        <h3 class="font-bold text-white text-base truncate" [title]="grupo.nombre_grupo">{{
                           grupo.nombre_grupo }}</h3>
                        <div class="flex items-center gap-3 mt-1">
                           <p class="text-orange-100 text-[11px] font-medium flex items-center gap-1">
                              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                 stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                 <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                 <circle cx="9" cy="7" r="4"></circle>
                                 <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                 <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                              </svg>
                              {{ getGroupMembers(grupo.id_grupo).length }} miembros
                           </p>
                           <span class="text-orange-300/50 text-[10px]">•</span>
                           <p class="text-white text-[11px] font-bold flex items-center gap-1">
                              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                 stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                 <path
                                    d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                                 </path>
                              </svg>
                              {{ getPrecursoresCount(grupo.id_grupo) }} Precursores
                           </p>
                        </div>
                     </div>
                  </div>

                  <!-- Sección de Liderazgo -->
                  <div class="px-4 py-3 bg-slate-50 border-b border-slate-100">
                     <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-2">Encargados del grupo
                     </p>
                     <div class="space-y-2">
                        <!-- Capitán Drop Zone -->
                        <div
                           class="relative flex items-start gap-2.5 p-2 rounded-lg transition-all duration-200 group/leader"
                           [ngClass]="{
                           'bg-white border border-slate-100': !isDraggingOverLeader() || isDraggingOverLeader()?.groupId !== grupo.id_grupo || isDraggingOverLeader()?.role !== 'capitan',
                           'bg-indigo-50 border-2 border-dashed border-indigo-300 scale-[1.02] shadow-sm z-10': isDraggingOverLeader()?.groupId === grupo.id_grupo && isDraggingOverLeader()?.role === 'capitan',
                           'bg-amber-50/50 border border-dashed border-amber-200': !grupo.capitan_grupo && (!isDraggingOverLeader() || isDraggingOverLeader()?.groupId !== grupo.id_grupo || isDraggingOverLeader()?.role !== 'capitan')
                        }" (dragover)="onDragOverLeader($event, grupo.id_grupo, 'capitan')"
                           (dragleave)="onDragLeaveLeader()" (drop)="onDropLeader($event, grupo.id_grupo, 'capitan')">
                           <div
                              class="w-7 h-7 rounded-full flex items-center justify-center shrink-0 mt-0.5 transition-colors pointer-events-none"
                              [ngClass]="{
                                 'bg-indigo-100 text-indigo-600': grupo.capitan_grupo || (isDraggingOverLeader()?.groupId === grupo.id_grupo && isDraggingOverLeader()?.role === 'capitan'),
                                 'bg-amber-100 text-amber-500': !grupo.capitan_grupo && !(isDraggingOverLeader()?.groupId === grupo.id_grupo && isDraggingOverLeader()?.role === 'capitan')
                              }">
                              <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                 stroke-width="2.5">
                                 <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                              </svg>
                           </div>
                           <div class="flex-1 min-w-0 pointer-events-none">
                              <div class="flex items-center justify-between">
                                 <p class="text-[9px] font-bold text-slate-400 uppercase">Capitán</p>
                                 <button *ngIf="grupo.capitan_grupo" (click)="removeLeader(grupo.id_grupo, 'capitan')"
                                    class="pointer-events-auto opacity-0 group-hover/leader:opacity-100 p-0.5 hover:bg-red-50 hover:text-red-500 rounded transition-all"
                                    title="Quitar asignación">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                 </button>
                              </div>
                              <p class="text-xs font-bold truncate transition-colors"
                                 [ngClass]="{'text-indigo-700': isLeaderModified(grupo.id_grupo, 'capitan'), 'text-slate-800': !isLeaderModified(grupo.id_grupo, 'capitan') && grupo.capitan_grupo, 'text-amber-600 italic': !grupo.capitan_grupo}">
                                 {{ grupo.capitan_grupo || 'Arrastra aquí...' }}
                              </p>
                              <!-- Tags de privilegios del Capitán -->
                              <div class="flex flex-wrap gap-1 mt-1"
                                 *ngIf="getPrivilegioTagsByName(grupo.capitan_grupo).length > 0">
                                 <span *ngFor="let tag of getPrivilegioTagsByName(grupo.capitan_grupo)"
                                    class="inline-flex items-center gap-0.5 text-[8px] font-bold px-1 py-0.5 rounded whitespace-nowrap"
                                    [ngClass]="tag.class">
                                    {{ tag.label }}
                                 </span>
                              </div>
                           </div>
                        </div>

                        <!-- Auxiliar Drop Zone -->
                        <div
                           class="relative flex items-start gap-2.5 p-2 rounded-lg transition-all duration-200 group/leader"
                           [ngClass]="{
                           'bg-white border border-slate-100': !isDraggingOverLeader() || isDraggingOverLeader()?.groupId !== grupo.id_grupo || isDraggingOverLeader()?.role !== 'auxiliar',
                           'bg-purple-50 border-2 border-dashed border-purple-300 scale-[1.02] shadow-sm z-10': isDraggingOverLeader()?.groupId === grupo.id_grupo && isDraggingOverLeader()?.role === 'auxiliar',
                           'bg-slate-50 border border-dashed border-slate-200': !grupo.auxiliar_grupo && (!isDraggingOverLeader() || isDraggingOverLeader()?.groupId !== grupo.id_grupo || isDraggingOverLeader()?.role !== 'auxiliar')
                        }" (dragover)="onDragOverLeader($event, grupo.id_grupo, 'auxiliar')"
                           (dragleave)="onDragLeaveLeader()" (drop)="onDropLeader($event, grupo.id_grupo, 'auxiliar')">
                           <div
                              class="w-7 h-7 rounded-full flex items-center justify-center shrink-0 mt-0.5 transition-colors pointer-events-none"
                              [ngClass]="{
                                 'bg-purple-100 text-purple-600': grupo.auxiliar_grupo || (isDraggingOverLeader()?.groupId === grupo.id_grupo && isDraggingOverLeader()?.role === 'auxiliar'),
                                 'bg-slate-100 text-slate-400': !grupo.auxiliar_grupo && !(isDraggingOverLeader()?.groupId === grupo.id_grupo && isDraggingOverLeader()?.role === 'auxiliar')
                              }">
                              <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                 stroke-width="2">
                                 <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                 <circle cx="9" cy="7" r="4"></circle>
                                 <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                 <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                              </svg>
                           </div>
                           <div class="flex-1 min-w-0 pointer-events-none">
                              <div class="flex items-center justify-between">
                                 <p class="text-[9px] font-bold text-slate-400 uppercase">Auxiliar</p>
                                 <button *ngIf="grupo.auxiliar_grupo" (click)="removeLeader(grupo.id_grupo, 'auxiliar')"
                                    class="pointer-events-auto opacity-0 group-hover/leader:opacity-100 p-0.5 hover:bg-red-50 hover:text-red-500 rounded transition-all"
                                    title="Quitar asignación">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                 </button>
                              </div>
                              <p class="text-xs font-medium truncate transition-colors"
                                 [ngClass]="{'text-purple-700 font-bold': isLeaderModified(grupo.id_grupo, 'auxiliar'), 'text-slate-700': !isLeaderModified(grupo.id_grupo, 'auxiliar') && grupo.auxiliar_grupo, 'text-slate-400 italic': !grupo.auxiliar_grupo}">
                                 {{ grupo.auxiliar_grupo || 'Arrastra aquí...' }}
                              </p>
                              <!-- Tags de privilegios del Auxiliar -->
                              <div class="flex flex-wrap gap-1 mt-1"
                                 *ngIf="getPrivilegioTagsByName(grupo.auxiliar_grupo).length > 0">
                                 <span *ngFor="let tag of getPrivilegioTagsByName(grupo.auxiliar_grupo)"
                                    class="inline-flex items-center gap-0.5 text-[8px] font-bold px-1 py-0.5 rounded whitespace-nowrap"
                                    [ngClass]="tag.class">
                                    {{ tag.label }}
                                 </span>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>

                  <!-- Listado de Publicadores -->
                  <div class="px-3 py-2 flex-1 overflow-y-auto custom-scrollbar">
                     <p class="text-[9px] font-bold text-orange-500 uppercase tracking-widest mb-2 px-1">Publicadores
                     </p>
                     <div class="space-y-2">
                        <ng-container *ngFor="let p of getGroupMembers(grupo.id_grupo)">
                           <ng-container
                              *ngTemplateOutlet="cardTemplate; context: { $implicit: p, inGroup: true }"></ng-container>
                        </ng-container>
                     </div>

                     <div *ngIf="getGroupMembers(grupo.id_grupo).length === 0"
                        class="py-8 flex flex-col items-center justify-center text-slate-300 text-xs border border-dashed border-slate-200 rounded-xl bg-slate-50/50 mt-2">
                        <svg class="w-6 h-6 opacity-40 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                           stroke-width="1.5">
                           <path stroke-linecap="round" stroke-linejoin="round"
                              d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span>Arrastra publicadores aquí</span>
                     </div>
                  </div>
               </div>

            </div>
         </div>
      </div>
   </div>
   <!-- Modal de Confirmación de Salida -->
   <div *ngIf="showExitConfirmation()" class="fixed inset-0 z-[10000] flex items-center justify-center p-4">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"
         (click)="showExitConfirmation.set(false)"></div>

      <!-- Modal Content -->
      <div
         class="bg-white rounded-2xl shadow-2xl w-full max-w-sm relative z-10 overflow-hidden animate-fade-in-up border border-slate-100">

         <div class="p-6 text-center">
            <div class="w-16 h-16 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-4">
               <svg class="w-8 h-8 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round"
                     d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
               </svg>
            </div>

            <h3 class="text-lg font-black text-slate-800 mb-2">¿Salir sin guardar?</h3>
            <p class="text-sm text-slate-500 font-medium leading-relaxed">
               Tienes <span class="text-orange-600 font-bold">{{ pendingChangesCount() }} cambios pendientes</span>. Si
               sales ahora, perderás todo el progreso no guardado.
            </p>
         </div>

         <div class="bg-slate-50 p-4 flex gap-3">
            <button (click)="showExitConfirmation.set(false)"
               class="flex-1 py-2.5 px-4 rounded-xl text-slate-600 font-bold text-sm hover:bg-white hover:shadow-sm border border-transparent hover:border-slate-200 transition-all">
               Cancelar
            </button>
            <button (click)="confirmExit()"
               class="flex-1 py-2.5 px-4 rounded-xl bg-gradient-to-r from-red-500 to-red-600 text-white font-bold text-sm shadow-lg shadow-red-500/30 hover:shadow-red-500/40 hover:from-red-600 hover:to-red-700 transition-all active:scale-95">
               Salir de todas formas
            </button>
         </div>
      </div>
   </div>

   <!-- Toast de Éxito -->
   <div *ngIf="showSuccessMessage()" class="fixed bottom-6 right-6 z-50 slide-in-bottom">
      <div
         class="bg-slate-900 text-white px-5 py-3.5 rounded-2xl shadow-2xl flex items-center gap-4 border border-slate-700/50 backdrop-blur-md bg-opacity-95">
         <div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 shrink-0">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
               <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
         </div>
         <div>
            <h4 class="font-bold text-sm text-white">Cambios guardados</h4>
            <p class="text-[11px] font-medium text-slate-400">La asignación se ha actualizado correctamente.</p>
         </div>
         <button (click)="showSuccessMessage.set(false)"
            class="text-slate-500 hover:text-white transition-colors ml-2 -mr-1 p-1">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
               <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
         </button>
      </div>
   </div>
</div>

<!-- Template de Card de Publicador - Diseño Limpio -->
<ng-template #cardTemplate let-p let-inGroup="inGroup">
   <div
      class="bg-white p-2.5 rounded-xl border border-slate-200 shadow-sm cursor-grab active:cursor-grabbing hover:shadow-md hover:border-slate-300 hover:scale-[1.01] transition-all duration-200 group relative flex items-center gap-2.5 select-none"
      draggable="true" (dragstart)="onDragStart($event, p)">
      <!-- Avatar - Icono de Usuario -->
      <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center shrink-0">
         <svg class="w-4 h-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
         </svg>
      </div>

      <!-- Info -->
      <div class="min-w-0 flex-1 flex flex-col justify-center">
         <p
            class="text-[13px] font-black text-slate-800 truncate leading-tight group-hover:text-brand-orange transition-colors">
            {{ p.primer_nombre }} {{ p.primer_apellido }}
         </p>
         <div class="flex items-center gap-1 mt-1 flex-wrap">
            <!-- Privilegios Tags con iconos -->
            <ng-container *ngIf="getPrivilegioTags(p).length > 0; else noPrivilegio">
               <span *ngFor="let tag of getPrivilegioTags(p)"
                  class="inline-flex items-center text-[9px] font-bold px-1.5 py-0.5 rounded-md whitespace-nowrap shadow-sm"
                  [ngClass]="tag.class" [title]="tag.label">
                  {{ tag.label }}
               </span>
            </ng-container>
            <ng-template #noPrivilegio>
               <span
                  class="text-[9px] text-slate-400 font-medium bg-slate-50 px-1.5 py-0.5 rounded-md border border-slate-100">
                  Publicador
               </span>
            </ng-template>
         </div>
      </div>

      <!-- Modified Indicator (Full Badge) -->
      <div class="absolute top-2 right-2" *ngIf="isModified(p)">
         <span class="flex h-2 w-2">
            <span
               class="animate-ping absolute inline-flex h-full w-full rounded-full bg-brand-orange opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-brand-orange"></span>
         </span>
      </div>
   </div>
</ng-template>